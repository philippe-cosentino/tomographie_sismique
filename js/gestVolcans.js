var tVolcans=[34.5,131.6,641,-23.3,-67.6,6046,14.5,-90.9,3976,38.6,34.5,1689,46.2,-121.5,3742,-25.4,-129.3,-39,37.6,140.3,1718,10.1,40.8,1733,13.1,40.9,1295,18.8,145.7,965,14.5,-90.7,3760,37.8,-25.5,947,-50.3,-73.8,2546,-8.3,115.5,3142,20.4,145.0,-137,54.0,159.5,1180,36.6,139.2,1828,43.4,144.0,1499,55.4,158.7,1956,39.8,140.8,1637,40.0,140.8,1366,29.5,129.6,584,54.1,-166.0,1303,50.9,155.6,2339,17.6,145.8,744,12.9,40.6,1501,41.7,12.7,949,-0.4,-91.1,1130,13.5,40.6,1031,14.9,39.9,904,-22.4,-68.0,4600,-16.3,168.1,1334,16.4,145.7,790,-20.2,169.8,852,56.9,-158.2,1341,-0.5,-78.1,5753,-15.4,167.8,1496,39.7,44.3,5165,10.5,-84.7,1670,-18.7,-69.1,5597,52.4,157.8,1910,36.4,138.5,2568,-8.0,-14.4,858,65.0,-16.8,1516,32.9,131.1,1592,14.6,-91.2,3535,52.4,-174.2,1533,44.8,147.1,1206,59.4,-153.4,1252,53.3,158.8,2741,3.7,125.5,1320,46.0,-130.0,-1410,10.1,40.7,2145,-21.8,-68.2,5846,37.7,140.3,2035,19.5,121.9,1180,43.8,121.6,2763,-6.1,155.2,1750,48.8,-121.8,3285,-3.6,144.9,685,-5.2,151.2,2248,37.6,140.1,1819,12.3,93.9,305,2.3,36.6,1032,28.0,60.0,3490,71.1,-8.2,2277,44.3,-121.8,2096,56.0,160.6,2882,11.5,124.5,1187,54.3,160.0,1720,12.8,124.1,1565,8.1,38.4,2281,4.2,9.2,4095,18.8,121.9,712,10.4,123.1,2435,36.5,-104.1,2494,33.7,-106.0,1730,0.0,-78.0,5790,-6.9,108.4,3078,45.8,3.0,1464,57.1,-157.0,2067,50.3,155.5,5958,-1.5,-78.8,6310,52.8,-170.0,1730,13.9,-89.5,746,19.5,103.6,4100,11.5,85.6,1610,-37.9,-71.2,2965,13.0,-87.6,847,-0.7,-78.4,5911,42.9,-122.1,2471,43.4,-113.5,2005,43.7,142.9,2290,-5.0,150.1,400,36.0,52.1,5670,-4.0,103.1,3173,43.5,-120.9,1525,44.6,-104.7,1558,43.1,-118.7,1450,-7.2,109.9,2565,51.5,157.0,1331,13.6,41.8,1625,1.7,127.9,1185,-16.7,168.4,-34,50.7,156.0,1156,-39.3,174.1,2518,-8.7,122.5,788,17.4,-93.2,1060,43.3,42.5,5633,-77.5,167.2,3794,13.6,40.7,613,37.7,15.0,3350,9.0,39.9,2007,-0.4,-91.6,1476,-54.6,-164.4,1095,15.0,-24.4,2829,43.4,-121.1,1716,55.1,-162.8,1920,14.5,-90.9,3763,28.4,-14.0,529,35.4,138.7,3776,37.8,-25.3,805,50.3,155.3,1772,1.2,-77.4,4276,-7.3,108.1,2168,0.8,127.3,1715,55.0,160.7,2576,1.4,127.5,1635,51.8,178.8,1573,-14.3,167.5,797,-6.8,106.9,2958,48.1,-121.1,3213,52.6,158.0,1829,39.0,-28.0,402,28.0,15.6,1950,52.1,-176.1,1740,58.4,-155.1,2317,64.4,-17.3,1725,-0.2,-78.6,4784,-18.4,-69.1,6071,17.3,145.8,287,35.2,139.0,1439,-53.1,73.5,2745,9.2,124.7,1332,27.7,-18.0,1500,45.4,-121.7,3426,19.7,-155.9,2523,1.5,127.6,1325,-8.1,114.2,2386,60.0,-153.1,3053,-8.3,123.3,1659,-0.7,-78.7,5248,13.7,-89.1,450,51.5,157.2,1578,24.8,141.3,161,20.5,122.0,1009,10.0,83.9,3431,54.8,-163.7,2446,13.8,-89.6,1950,19.2,-98.6,5286,34.9,139.1,581,1.1,127.4,1130,44.7,-121.8,3199,43.1,-117.4,1400,-3.6,144.6,365,58.6,-154.1,901,20.6,-156.6,450,51.3,156.9,2156,51.9,-177.2,1307,10.4,123.1,2435,2.8,125.4,1784,-1.5,29.5,4507,-11.8,43.4,2361,54.1,159.5,1536,63.6,-19.1,1512,58.3,-155.0,2047,-0.1,29.9,1067,-9.0,158.0,-20,51.7,157.4,900,-7.9,112.3,1731,1.7,101.3,3800,52.1,157.7,2090,57.2,-156.8,1677,12.3,-61.6,-185,30.8,130.3,704,54.5,160.3,1552,19.4,-155.3,1222,3.1,37.4,5895,31.9,130.9,1700,56.1,160.6,4835,42.1,140.7,1131,8.8,39.7,1619,53.3,158.7,3456,51.4,156.8,1812,65.7,-16.8,818,-6.1,105.4,813,54.6,160.3,1856,54.8,160.5,3528,51.8,157.5,1079,58.5,-154.4,2043,36.6,138.5,2171,43.6,144.4,999,42.5,141.2,581,-16.8,168.5,-2,28.6,-17.8,2426,-9.0,148.2,1680,-5.5,148.4,1330,29.0,-13.6,670,-23.4,-67.7,5592,-8.4,122.8,1117,-8.5,122.8,1703,-8.3,123.5,1423,17.4,-62.8,1156,38.5,15.0,602,52.0,178.5,1174,18.9,-155.3,-975,1.4,124.8,1580,-5.5,150.5,805,-4.9,151.2,858,-6.5,155.6,1887,-5.4,147.1,1280,-0.9,36.5,2776,-16.5,168.4,1413,11.5,-85.5,1394,58.2,155.3,2165,1.4,124.9,1324,0.3,127.4,1357,54.1,159.7,1560,-4.1,145.0,1807,14.5,120.5,1388,2.3,38.0,1707,12.0,-86.2,635,51.1,156.7,503,43.6,144.6,855,19.8,-155.5,4205,19.5,-155.6,4170,13.3,123.7,2462,-53.0,72.6,230,42.5,-122.3,2894,37.4,4.1,1067,43.7,-112.0,1713,-0.2,36.1,2278,-7.5,110.4,2911,-7.5,110.4,3145,-3.3,36.8,4565,37.6,23.3,760,-19.2,-174.9,43,-57.8,-26.5,990,19.9,-101.8,3860,36.7,24.4,751,34.1,139.5,815,51.9,-176.8,1196,0.1,-78.3,4263,12.4,-86.5,1297,37.6,-25.9,-197,38.0,-119.0,2121,-25.9,-177.2,-132,0.5,127.4,950,-6.6,110.9,1625,36.8,139.5,2486,37.1,140.0,1915,12.5,-86.7,728,49.6,154.8,1018,17.2,-62.6,985,43.7,-121.2,2434,-37.8,142.5,1011,-39.1,175.6,1978,36.8,139.4,2578,43.5,143.0,2013,36.6,27.2,698,0.2,37.9,750,-1.4,29.2,3058,-1.5,29.3,3470,-27.1,-68.6,6887,-38.1,176.5,1111,53.4,-168.1,1073,6.3,10.5,3011,-2.8,39.9,2962,52.5,157.3,1776,64.0,-16.7,2119,34.7,139.4,764,14.4,-90.6,2552,18.1,145.8,570,-5.6,150.5,742,-7.3,107.7,2665,19.5,-102.2,3170,-18.2,-69.2,6348,51.5,157.0,1070,55.4,-161.9,2519,55.5,-161.8,2142,14.8,-61.2,1397,4.9,96.3,2801,38.5,-28.4,2351,11.5,-85.6,1700,31.8,-113.5,1200,15.1,120.4,1486,34.8,-116.6,1495,-21.2,55.7,2631,10.2,-84.2,2708,19.0,-98.6,5246,47.0,152.1,1360,2.3,-76.4,4650,17.5,-63.0,601,-4.3,152.2,688,7.7,124.5,2815,48.3,153.3,551,46.9,-121.8,4392,-5.8,105.6,1281,-29.3,-177.9,516,47.8,153.0,956,-8.1,114.0,3332,44.1,145.1,1660,60.5,-152.7,3108,-0.1,-77.7,3562,10.8,-85.3,1916,54.8,-163.6,1871,-39.3,175.6,2797,45.9,149.8,542,4.9,-75.3,5321,-36.1,178.1,500,17.6,-63.2,887,-15.8,-71.9,5967,-5.4,148.1,992,31.6,130.7,1117,-6.7,106.7,2211,12.7,-87.0,1745,13.7,-89.3,1893,16.9,-25.0,697,62.2,-144.1,4949,-2.0,-78.3,5230,13.9,-89.6,2381,14.8,-91.6,3772,36.4,25.4,367,48.1,153.2,1496,-9.1,159.8,485,52.0,178.1,1160,-8.1,112.9,3676,51.9,179.6,1221,37.9,-25.8,856,41.4,-122.2,4317,56.7,161.4,3283,42.7,141.4,1320,44.1,145.2,1563,54.8,-164.0,2857,48.9,154.2,934,44.4,146.1,1189,-39.0,-71.5,2282,1.1,124.7,1784,16.1,-61.7,1467,16.7,-62.2,915,13.3,-61.2,1220,2.6,36.6,800,35.6,-111.6,2141,61.3,-152.3,3374,47.6,152.9,36,58.4,-154.4,2272,38.8,15.2,924,-0.5,-77.6,3990,-7.4,110.1,3371,-7.3,110.0,3136,35.4,-111.5,2447,-1.2,36.4,2356,29.6,129.7,799,14.0,121.0,311,-1.0,100.7,2597,-8.3,118.0,2850,-8.3,118.0,2850,51.9,-178.2,1806,51.9,-178.2,1806,-6.8,107.6,2084,49.4,154.7,1325,20.9,17.3,3100,12.6,-86.9,1010,28.3,-16.6,3715,-7.9,113.0,2329,44.5,-121.8,2390,44.1,121.8,3100,-59.5,-27.4,1075,44.4,146.3,1819,2.6,98.8,2157,1.3,127.5,979,43.4,142.7,2077,55.8,160.3,3682,14.6,-91.2,3158,40.5,140.9,1159,-18.8,169.2,1881,45.9,149.9,998,-37.1,-12.3,2060,33.3,131.4,1584,-1.5,-78.4,2011,37.0,-117.5,752,-16.4,-70.9,5672,55.8,160.5,2923,57.8,-156.4,1474,36.4,-113.1,1555,-5.1,151.3,2334,-5.6,147.9,1548,-18.3,144.8,1020,-7.2,110.3,2050,32.8,130.3,1500,47.1,152.3,678,47.5,152.8,401,42.5,140.8,737,54.5,160.0,1617,56.2,-159.4,2507,50.6,156.0,1183,40.8,14.4,1281,-39.4,-71.9,2847,52.7,158.3,2173,-1.5,29.5,3711,53.1,-168.7,2149,38.4,15.0,500,44.3,-121.8,2376,25.1,17.6,547,54.5,-164.7,1654,-37.5,177.2,321,62.0,-144.0,4317,48.7,126.1,597,36.2,137.6,2455,36.7,27.1,180,57.0,-157.2,1345,-19.5,169.4,361,44.4,-110.7,2805,46.9,152.0,624,51.6,157.3,1953,53.6,159.2,2958,55.9,160.6,3081];
var meshVolcans;
var volcansVisibles=false;
var nVolcans;

function placeVolcansSurGlobe () {
	var singleGeometry = new THREE.Geometry();
	var geomVolcan=new THREE.BoxGeometry(10, 10, 10);
	var matVolcan= new THREE.MeshBasicMaterial({
				color: '#FF2222',
				transparent: true,
				opacity: 0.9
			 });
			 
	var meshV = new THREE.Mesh(geomVolcan);		
	nVolcans=tVolcans.length/3;
	for (var i=0;i<nVolcans;i++) {
			//console.log (tVolcans[i*3]*1+" "+tVolcans[i*3+1]*1);
			deplaceCube (meshV,tVolcans[i*3]*1,tVolcans[i*3+1]*1);
			meshV.updateMatrix(); // as needed
			singleGeometry.merge(meshV.geometry, meshV.matrix);
		
	}	
	
	var bufferGeometry = new THREE.BufferGeometry().fromGeometry( singleGeometry);
	
	meshVolcans = new THREE.Mesh(bufferGeometry, matVolcan);
    scene.add(meshVolcans);
	meshVolcans.visible=false;
}

function checkVolcans() {
	volcansVisibles=!volcansVisibles;
	meshVolcans.visible=volcansVisibles;
	if (volcansVisibles===true) {
		document.getElementById("check_volcans").style.display="block";
		setSliders();
		
	} else {
		document.getElementById("check_volcans").style.display="none";
	}
	
	if ((volcansVisibles===true)||(foyersVisibles===true)) {
		document.getElementById("div_tol").style.display="block";
		document.getElementById("range-slider-4").style.display="block";
		document.getElementById("valeur-ranger4").style.display="block";
		setSliders();
		
	} else {
		document.getElementById("div_tol").style.display="none";
		document.getElementById("range-slider-4").style.display="none";
		document.getElementById("valeur-ranger4").style.display="none";
	}
	
	render(true);
	if (coupeFaite) {
		if (volcansVisibles) {
			// tracer les volcans
			trouveVolcansArc();
		}
		traceCoupe(ctCoupe);
	}
}



var tvv=new Array();
function trouveVolcansArc () {
	// par précaution on recalcule l'angle
	calcAngleCoupe();
	// cherche les foyers proches de l'arc et les stocke dans tvv
	tvv.length=0;
	var pta={};
	var ptb={};
	var ptm={};
	pta=cloneObj(wpgc[0]);
	pta.longi+=360;
	ptb=cloneObj(wpgc[nbwp-1]);
	ptb.longi+=360;

	ptm=cloneObj(wpgc[Math.floor(nbwp/2)]); // milieu
	if (ptm.longi>180)
	{
		ptm.longi=ptm.longi-360;
	}
	
	var ptf={};
	var ptf2={};
	var pth={};
	
	var dah=0;  // distance de A à H
	var nf=0;
	var dmax=lcoupe*toleranceCoupe;
	var ldmax=lcoupe/2; //+dmax ?
	var antipodes=false;
	
	var angleFoyer,profFoyer,alpha;
	
	//console.log ("dmax="+dmax);
	
	//console.log ("ldmax="+ldmax);
	
	var latf,longf,proff;
	
	for (var i=0;i<nVolcans;i++)
	{
		latf=tVolcans[i*3];
		longf=corrigeLong(tVolcans[i*3+1]);
		proff=-tVolcans[i*3+2]/1000;
		ptf.lati=latf;
		ptf.longi=longf;
		ptf2.longi=ptf.longi;
		ptf2.lati=ptf.lati;
		antipodes=false;
		if (longf<0)
		{
			longf=longf+180;
			latf=-latf;
			antipodes=true;
		}
		ptf.lati=latf;
		ptf.longi=longf;	
		
		pth=projarc(pta,ptb,ptf,ptm);
		if (antipodes)
		{
			pth.longi=pth.longi+180;
			pth.lati=-pth.lati;
		}
		

		if (pth.longi>180)
		{
			pth.longi=pth.longi-360;
		}
		
		d=dgrand_cercle(ptf2,pth);
		if (d<(dmax))
		{
		
			dm=dgrand_cercle(ptm,pth);
			if (dm<ldmax)
			{
				dah=dgrand_cercle(pta,pth)/lcoupe; // position en fraction (0 à 1) sur l'arc
				angleFoyer=(1-dah)*angle0C + dah*angle1C;
							
				if ((angleFoyer>angle0C)&&(angleFoyer<angle1C))
				{
					// enregistrement du volcan
					tvv[nf]={lati:latf,longi:longf,prof:proff};
					tvv[nf].angleFoyer=angleFoyer;
					tvv[nf].dm=dm;
					tvv[nf].ldmax=ldmax;
					alpha=1-(d/dmax);
					alpha=Math.round(alpha*1000)/1000;
					tvv[nf].alpha=alpha;
					nf++;
				}
			}
		}
	}
	
	//§§§§§§§§§§§§ FIN SEISMES
}


function afficheVolcansSurCoupe (ctx) {
	var x,y,rFoyer,alpha,rf,angle;
	for (var i=0;i<tvv.length;i++)
	{
		rFoyer=alti2R(-tvv[i].prof);
		angle=tvv[i].angleFoyer;
		x=Math.round(xCentre+Math.cos(angle)*rFoyer);
		y=Math.round(yCentre+Math.sin(angle)*rFoyer);
		rf=10*lCT/800;
		ctx.beginPath();
		alpha=tvv[i].alpha;
		ctx.strokeStyle="rgba(0,0,0,"+alpha+")";
		ctx.fillStyle="rgba(200,0,0,"+alpha+")";
		ctx.beginPath();
		ctx.moveTo(x,y-rf/2);
		ctx.lineTo(x-rf/2,y+rf/2);
		ctx.lineTo(x+rf/2,y+rf/2);
		ctx.lineTo(x,y-rf/2);
		ctx.closePath();
		ctx.fill();
		ctx.stroke();
	}	
	if (tvv.length>0) {
		// légende
		var x=x0CT+lCT*0.9;
		var y=y0CT+hCT*0.95;
		var rf=10*lCT/800;
		var alpha=1;
		ctx.strokeStyle="rgba(0,0,0,"+alpha+")";
		ctx.fillStyle="rgba(200,0,0,"+alpha+")";
		ctx.beginPath();
		ctx.moveTo(x,y-rf/2);
		ctx.lineTo(x-rf/2,y+rf/2);
		ctx.lineTo(x+rf/2,y+rf/2);
		ctx.lineTo(x,y-rf/2);
		ctx.closePath();
		ctx.fill();
		ctx.stroke();
		x+=lCT*0.01;
		ctx.fillStyle="black";
		var hFont=Math.round(hCT/4.5)/10;
		ctx.font=hFont+"px "+dFont;
		ctx.fillText ("volcan",x+hFont/2,y+hFont*0.35);
	}
}